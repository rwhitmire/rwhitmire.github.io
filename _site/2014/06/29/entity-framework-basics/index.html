<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge"> 
    <meta name="description" content="Ryan's technology space">
    <meta name="author" content="Ryan Whitmire">
    <link rel="shortcut icon" href="favicon.png">
    <link href='http://fonts.googleapis.com/css?family=Source+Code+Pro' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Share+Tech' rel='stylesheet' type='text/css'>

    <title>Entity Framework Basics</title>

    <!-- Bootstrap core CSS -->
    <link href="/css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="/css/font-awesome.min.css" rel="stylesheet">
    <link href="/css/syntax.css" rel="stylesheet">
    <link href="/css/site.css" rel="stylesheet">

    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="/js/vendor/html5shiv.js"></script>
    <script src="/js/vendor/respond.min.js"></script>
    <![endif]-->

    <script src="/js/vendor/jquery-1.11.0.min.js"></script>
    <script src="/js/vendor/bootstrap.min.js"></script>
</head>

<body>
    <div class="container">
        <div class="navbar navbar-default" role="navigation">
            <div class="container-fluid">
                <div class="navbar-header">
                    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                </div>
                <div class="navbar-collapse collapse">
                    <ul class="nav navbar-nav">
                        <li><a href="/"><i class="fa fa-home"></i> Home</a></li>
                        <li><a href="/archive"><i class="fa fa-folder-o"></i> Blog Archive</a></li>
                        <li><a href="http://github.com/rwhitmire" target="_blank"><i class="fa fa-github-alt"></i> Projects</a></li>
                        <li><a href="/about"><i class="fa fa-info"></i> About</a></li>
                        <li><a href="/contact"><i class="fa fa-envelope-o"></i> Contact</a></li>
                    </ul>
                </div><!--/.nav-collapse -->
            </div><!--/.container-fluid -->
        </div>
        <div class="content">
            
	<article>
		<div class="header"><h1>Entity Framework Basics</h1></div>
		<div class="content"><p>We recently had an incident in production at my place of employment where memory spikes were intermittently occuring
in one of our .NET web applications. The problem was eventually tracked back to some Entity Framework code
that had been written by a senior level developer. At first, I was shocked that this developer didn't understand the code
he had written and why the code was problematic. However, certain abstractions within the Entity Framework make this particular
issue very easy to overlook without a solid understanding of the library.</p>

<h2>What this post isn't about</h2>

<p>This post is not about showing you how to use Entity Framework or how to do "code first". This post is intended to help you
understand what exactly is going on behind the scenes, and how to prevent the situation described in the previous paragraph.
Most of the Entity Framework tutorials I've read mention nothing about the "magic" occuring as you write your fancy chained
linq statements to pull data out of a database. This is information you must know if you are looking to solve problems with EF.</p>

<h2>Materializing</h2>

<p>When considering the performance of your application, materializing has to be your #1 concern when using EF. So what is materializing?
I don't really know the official meaning of matrializing, but I think of it as <strong>transfering data into in-memory objects</strong>. That concept is
extremely important when using EF, and here is why.</p>

<p>Let's say we have the following service to get some data from our database:</p>

<div class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">class</span> <span class="nc">ProductService</span> <span class="p">:</span> <span class="n">IProductService</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="n">IRepository</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;</span> <span class="n">_repository</span><span class="p">;</span>

    <span class="k">public</span> <span class="nf">ProductService</span><span class="p">(</span><span class="n">IRepository</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;</span> <span class="n">repository</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">_repository</span> <span class="p">=</span> <span class="n">repository</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;</span> <span class="n">GetAllProducts</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">// assume the GetAll method returns an IQueryable</span>
        <span class="k">return</span> <span class="n">_repository</span><span class="p">.</span><span class="n">GetAll</span><span class="p">().</span><span class="n">ToList</span><span class="p">();</span>
    <span class="p">}</span> 
<span class="p">}</span></code></pre></div>


<p>And then we have the following action method to display that data in a view:</p>

<div class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">class</span> <span class="nc">ProductsController</span> <span class="p">:</span> <span class="n">Controller</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="n">IProductService</span> <span class="n">_productService</span><span class="p">;</span>

    <span class="k">public</span> <span class="nf">ProductsController</span><span class="p">(</span><span class="n">IProductService</span> <span class="n">productService</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">_productService</span> <span class="p">=</span> <span class="n">productService</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="n">ActionResult</span> <span class="nf">ShowProducts</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">sortedProducts</span> <span class="p">=</span> <span class="n">_productService</span><span class="p">.</span><span class="n">GetAllProducts</span><span class="p">().</span><span class="n">OrderBy</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">OrderDate</span><span class="p">);</span>
        <span class="k">return</span> <span class="nf">View</span><span class="p">(</span><span class="n">sortedProducts</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></div>


<p>This is bad! If you know why this is bad, you can leave now - this post isn't meant for you. If you do not know why this
is bad, stop writing Entity Framework code immediately and don't do any more until you fully understand the contents of this blog post.</p>

<h2>IQueryable</h2>

<p>When you write an Entity Framework query, you are more than likely using common LINQ statements to fetch your data. For example:</p>

<div class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="n">IQueryable</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;</span> <span class="n">GetNewProducts</span><span class="p">()</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">newDate</span> <span class="p">=</span> <span class="n">DateTime</span><span class="p">.</span><span class="n">Today</span><span class="p">.</span><span class="n">AddDays</span><span class="p">(-</span><span class="m">10</span><span class="p">);</span>
    <span class="kt">var</span> <span class="n">products</span> <span class="p">=</span> <span class="n">_repository</span><span class="p">.</span><span class="n">GetAll</span><span class="p">().</span><span class="n">Where</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">CreatedDate</span> <span class="p">&gt;</span> <span class="n">newDate</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">products</span><span class="p">;</span>
<span class="p">}</span></code></pre></div>


<p>If we debug this code and take a look at what's going on with that products collection, we see this:</p>

<p><img src="/images/entity-framework-basics/query-example.png" alt="Query" /></p>

<p>As you can see, our products haven't been queried yet. That LINQ statement is doing some magic to build a SQL
query. Now look at what happens if I add a <code>.ToList()</code> to the end of that LINQ statement:</p>

<p><img src="/images/entity-framework-basics/materialized.png" alt="Query" /></p>

<p>The SQL transaction has now been executed and your list is in memory. For the sake of this demonsration, my
product list is very small. However, a real-world production database could have millions or even billions of products
with a strategically placed index on the CreatedDate property. You do not want your web server sorting and querying
this data in memory. You want SQL server to do the work.</p>

<h2>So I should never use .ToList() right?</h2>

<p>Wrong. I would recommend using a <code>.ToList()</code> explicitly at some point to denote that you are now converting your
query into an in-memory list. Even better, wrap the <code>.ToList()</code> method into an extension called something like <code>.Materialize()</code>.
If your IQueryable ends up making it to the view, the view could end up doing all sorts of interesting things to materialize data.
When writing EF code, please be mindful of what is going on behind the scenes. Understand and write self-documenting code to explain exactly
where the query is executing. Doing this will prevent strange memory spikes from bogging down your software.</p>
</div>
		<div class="comments"><div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'rwhitmire'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a></div>
	</article>


        </div>
        <footer>
            Copyright &copy; 2014 - Ryan Whitmire
        </footer>
    </div>
    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-44983727-1', 'rwhitmire.com');
  ga('send', 'pageview');
</script>

</body>
</html>
