{% capture date %}{{ post.date }}{% endcapture %}
{% capture this_year %}{{ date | date: "%Y" }}{% endcapture %}
{% unless year == this_year %}
  {% assign year = this_year %}
  {% unless forloop.first %}
    </ul>
  {% endunless %}
  <h2 class="year">{{ date | date: "%Y" }}</h2>
  <ul>
{% endunless %}
  <li>
    <h3 class="title"><a href="{{ post.url }}">{{post.title}}</a></h3>
  </li>